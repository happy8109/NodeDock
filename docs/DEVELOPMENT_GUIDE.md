# NodeDock 开发文档

## 1. 项目概况
**项目名称**：NodeDock (Node.js 应用驻留管理中心)  
**开发背景**：在 Windows 开发或服务器环境下，运行多个 Node.js 程序通常需要打开多个 CMD/终端窗口。这不仅占用任务栏空间，且容易被误关闭。此外，不同项目往往依赖不同版本的 Node.js。  
**目标平台**：.NET Framework 4.6.2 (Windows 桌面环境)

---

## 2. 开发目的
1. **静默运行**：将 Node.js 程序转为后台进程运行，消除桌面上杂乱的黑窗口。
2. **多版本共存**：在管理程序内集成多个 Node.js 执行环境，实现“随包带走，按需运行”，摆脱操作系统全局 Node 版本的限制。
3. **集中管控**：提供统一的 UI 界面，实现对分散在不同目录下 Node.js 项目的起停、监控。
4. **易用性**：支持最小化至系统托盘，保持桌面整洁。

---

## 3. 总体设计方案

### 3.1 技术栈选择
*   **开发语言**：C# 6.0
*   **框架**：.NET Framework 4.6.2
*   **配置存储**：JSON 格式 (Newtonsoft.Json)
*   **底层进程控制**：System.Diagnostics.Process

### 3.2 目录结构方案
为了实现多版本集成，项目将采用以下物理布局：
```text
NodeDock/ (根目录)
├── runtimes/                 # 存放不同版本的 node 执行程序
│   ├── v14.21.3/
│   │   └── node.exe
│   └── v18.16.0/
│       └── node.exe
├── config/
│   └── settings.json         # 记录应用列表、路径、关联版本
├── docs/
│   └── DEVELOPMENT_GUIDE.md  # 本文档
└── NodeDock.exe              # 主程序
```

### 3.3 核心业务流程
1. **启动应用**：
    - 读取配置中关联的 `NodeRuntimePath`（若为空则使用默认版本）。
    - 设置 `ProcessStartInfo` 的 `WorkingDirectory` 为项目实际所在目录。
    - 设置 `CreateNoWindow = true` 实现黑窗口遮蔽。
    - 重定向 `StandardOutput` 和 `StandardError` 流，以便在 UI 层面实时确认启动状态。
2. **托盘交互**：
    - 管理器最小化时隐藏主窗体，仅在右下角托盘保留图标。
    - 托盘图标右键菜单支持“全部启动”、“全部停止”、“退出”等快捷操作。

---

## 4. 功能逻辑设计

### 4.1 程序管理器 (NodeProcessManager)
*   **状态维护**：通过 `Process.HasExited` 属性及 `Exited` 事件监听，维护应用的实时状态。
*   **生命周期**：封装 `Start()`、`Stop()`（Force Kill）、`Restart()` 方法。
*   **单例保证**：确保同一个配置项在同一时间只能启动一个进程实例。

### 4.2 配置管理 (ConfigService)
*   **核心配置模型**：
    - `Id`: 唯一标识。
    - `Name`: 显示名称。
    - `WorkingDirectory`: 程序所在绝对路径。
    - `EntryScript`: 执行脚本（相对于 WorkingDirectory 或绝对路径）。
    - `NodeVersion`: 所选 Runtime 的文件夹内名称。
    - `AutoStart`: 程序随管理器启动而启动。

### 4.3 UI/UX 设计方案
*   **视觉风格**：深色调（Dark Mode），采用 WinForms 自定义绘图或控件组合实现现代感。
*   **关键界面**：
    - **主列表视图**：显示各应用的名称、状态、关联版本、运行时间。
    - **输出预览窗格**：用于显示 Node 程序通过控制台输出的最近 100 行信息（阅后即焚，不持久化）。

---

## 5. 关键技术问题与对策
1. **分散目录支持**：
    - *对策*：在启动时明确设置 `WorkingDirectory`。
2. **进程隔离与残留处理**：
    - *对策*：通过管理器的退出钩子，确保在管理员关闭时能够遍历并清理所管理的子进程，防止“断线”后的僵尸 Node 进程继续运行。
3. **中文乱码**：
    - *对策*：针对不同环境下的编码标准，统一将 `StandardOutputEncoding` 强制设为 `UTF8`。

---

## 6. 后续扩展构思
*   **开机自启动**：添加注册表项实现 Windows 登录自动启动。
*   **分组管理**：支持将不同的 Node 程序按业务类型（如：后端、前端打包工具、任务脚本）进行分组。
*   **图标管理**：允许用户为不同的 Node 项目设置自定义图标。
