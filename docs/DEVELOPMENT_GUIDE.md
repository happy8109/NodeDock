# NodeDock 开发文档

## 1. 项目概况
**项目名称**：NodeDock (Node.js 应用驻留管理中心)  
**开发背景**：在 Windows 开发或服务器环境下，运行多个 Node.js 程序通常需要打开多个 CMD/终端窗口。这不仅占用任务栏空间，且容易被误关闭。此外，不同项目往往依赖不同版本的 Node.js。  
**目标平台**：.NET Framework 4.6.2 (Windows 桌面环境)

---

## 2. 开发目的
1. **静默运行**：将 Node.js 程序转为后台进程运行，消除桌面上杂乱的黑窗口。
2. **多版本共存**：在管理程序内集成多个 Node.js 执行环境，实现“随包带走，按需运行”，摆脱操作系统全局 Node 版本的限制。
3. **集中管控**：提供统一的 UI 界面，实现对分散在不同目录下 Node.js 项目的起停、监控。
4. **易用性**：支持最小化至系统托盘，保持桌面整洁。

---

## 3. 总体设计方案

### 3.1 技术栈选择
*   **开发语言**：C# 6.0
*   **框架**：.NET Framework 4.6.2
*   **配置存储**：JSON 格式 (Newtonsoft.Json)
*   **底层进程控制**：System.Diagnostics.Process

### 3.2 目录结构方案
为了实现多版本集成，项目将采用以下物理布局：
```text
NodeDock/ (根目录)
├── runtimes/                 # 存放不同版本的 node 执行程序
│   ├── v14.21.3/
│   │   ├── node.exe
│   │   ├── npm.cmd           # 集成 npm 支持
│   │   └── node_modules/     # npm 源代码目录
│   └── v18.16.0/
│       ├── node.exe
│       ├── npm.cmd
│       └── node_modules/
├── config/
│   └── settings.json         # 记录应用列表、路径、关联版本
├── docs/
│   └── DEVELOPMENT_GUIDE.md  # 本文档
└── NodeDock.exe              # 主程序
```

### 3.3 核心业务流程
1. **启动应用**：
    - 读取配置中关联的 `NodeRuntimePath`（若为空则使用默认版本）。
    - 设置 `ProcessStartInfo` 的 `WorkingDirectory` 为项目实际所在目录。
    - 设置 `CreateNoWindow = true` 实现黑窗口遮蔽。
    - 重定向 `StandardOutput` 和 `StandardError` 流，以便在 UI 层面实时确认启动状态。
2. **托盘交互**：
    - 管理器最小化时隐藏主窗体，仅在右下角托盘保留图标。
    - 托盘图标右键菜单支持“全部启动”、“全部停止”、“退出”等快捷操作。

---

## 4. 功能逻辑设计

### 4.1 程序管理器 (NodeProcessManager)
*   **状态维护**：通过 `Process.HasExited` 属性及 `Exited` 事件监听，维护应用的实时状态。
*   **生命周期**：封装 `Start()`、`Stop()`（Force Kill）、`Restart()` 方法。
*   **单例保证**：确保同一个配置项在同一时间只能启动一个进程实例。

### 4.2 配置管理 (ConfigService)
*   **核心配置模型**：
    - `Id`: 唯一标识。
    - `Name`: 显示名称。
    - `WorkingDirectory`: 程序所在绝对路径。
    - `EntryScript`: 执行脚本（相对于 WorkingDirectory 或绝对路径）。
    - `NodeVersion`: 所选 Runtime 的文件夹内名称。
    - `AutoStart`: 程序随管理器启动而启动。

### 4.3 UI/UX 设计方案
*   **视觉风格**：深色调（Dark Mode），采用 WinForms 自定义绘图或控件组合实现现代感。
*   **关键界面**：
    - **主列表视图**：显示各应用的名称、状态、关联版本、运行时间、资源占用 (CPU%|MemMB)。
    - **扁平化日志区域**：放弃标准 TabControl，采用 `FlowLayoutPanel` + 自定义按钮实现轻量级标签切换。
    - **输出预览窗格**：用于显示 Node 程序通过控制台输出的最近 100 行信息（阅后即焚，不持久化）。

### 4.4 版本探测服务 (PackageJsonService)
*   **自动探测**：读取项目目录下的 `package.json` 文件，解析 `engines.node` 字段获取版本需求。
*   **版本匹配**：支持常见版本表达式的解析与匹配：
    - `>=18.0.0`：大于等于指定版本
    - `^20.0.0`：兼容指定主版本
    - `~18.1.0`：兼容指定主次版本
    - `18.x` / `18.*`：匹配指定主版本
*   **推荐标识**：在版本下载列表中，符合项目需求的版本会标记 ⭐ 推荐，并自动优先显示。
*   **智能推荐策略**：为避免推荐过多版本（如 `>=14.0.0` 会匹配几乎所有版本），系统采用分组策略——仅推荐每个主版本中满足条件的最新版本。
*   **自动选择**：若已安装版本中存在满足需求的版本，系统会自动选中。
*   **Windows 7 特殊标注**：Node.js v13.14.0 会被标注为 `[Win7最后支持版本]`，即使它不是 LTS 版本也会显示在下载列表中。

### 4.5 设置管理 (SettingsService)

#### 4.5.1 运行时版本管理
*   **已安装列表**：扫描 `runtimes/` 目录，展示所有已安装的 Node.js 版本及其磁盘占用大小。
*   **删除版本**：支持删除选中的版本。删除前需检查是否有应用正在使用该版本，若有则提示用户确认或阻止删除。
*   **默认版本**：支持设置一个默认版本，当新建应用未指定版本时自动关联。

#### 4.5.2 开机自启动
*   **实现方式**：通过注册表项 `HKCU\Software\Microsoft\Windows\CurrentVersion\Run` 实现。
*   **开关控制**：提供开关按钮，用户可随时开启或关闭开机自启动功能。
*   **状态同步**：每次打开设置界面时，从注册表读取当前状态以确保显示与实际一致。

#### 4.5.3 下载镜像源切换
*   **支持镜像源**：
    - 官方源：`https://nodejs.org/dist/`
    - 淘宝镜像：`https://npmmirror.com/mirrors/node/`
*   **配置持久化**：镜像源选择保存至 `config/settings.json`，下次启动时自动加载。
*   **即时生效**：切换镜像源后，后续的版本列表获取和下载操作立即使用新源。

#### 4.5.4 Windows 7 兼容模式
*   **功能背景**：Node.js v14 及更高版本在 Windows 7 上运行会提示不支持。通过注入 `NODE_SKIP_PLATFORM_CHECK=1` 环境变量，可以强制 v18.16.1 等版本在 Windows 7 上运行。
*   **环境变量注入**：在 `NodeProcessWorker` 启动进程时，由管理器动态注入该变量，避免修改系统全局变量，保证环境隔离。
*   **智能限制**：系统会自动检测环境版本。若当前操作系统高于 Windows 7（版本号 > 6.1），该选项将自动置灰禁用，以防止误开启。

### 4.6 进阶功能逻辑

#### 4.6.1 进程守护 (Process Guarding)
*   **核心逻辑**：通过监听 `Process.Exited` 事件并检查 `ExitCode`。
*   **重启策略**：支持配置最大重启次数、重启窗口时间以及重启延迟。若在指定时间内连续崩溃超过阈值，系统将停止自动重启并标记为 `Error` 状态。

#### 4.6.2 资源监控 (Resource Monitoring)
*   **作业对象集成**：利用 Windows `JobObject` 实现对进程树（主进程+子进程）的精确监控。
*   **指标采集**：通过 P/Invoke 调用 `QueryInformationJobObject` 获取内核/用户 CPU 时间，并遍历作业内的 PID 累加工作集内存。
*   **异步刷新**：`ManagerService` 中维护 2s 间隔的定时器进行异步采样，确保 UI 响应不受性能监控影响。

---


## 5. 关键技术问题与对策
1. **分散目录支持**：
    - *对策*：在启动时明确设置 `WorkingDirectory`。
2. **进程隔离与残留处理**：
    - *对策*：通过管理器的退出钩子，确保在管理员关闭时能够遍历并清理所管理的子进程，防止“断线”后的僵尸 Node 进程继续运行。
3. **中文乱码**：
    - *对策*：针对不同环境下的编码标准，统一将 `StandardOutputEncoding` 强制设为 `UTF8`。
4. **多进程资源统计**：
    - *对策*：单纯 `Process` 对象无法追踪子进程资源。通过 Windows `JobObject` 强绑定进程树，实现“主+子”总占用的精确统计。
5. **.NET 低版本兼容性**：
    - *对策*：在 v4.6.2 等环境下，优先使用非泛型 `Marshal` 接口（如 `PtrToStructure`）以确保 API 调用的稳定性。
6. **Windows 7 高版本 Node 运行**：
    - *对策*：通过 `ProcessStartInfo.EnvironmentVariables` 动态注入 `NODE_SKIP_PLATFORM_CHECK=1` 环境变量，绕过平台版本检测。

---

## 6. 后续扩展构思 (Roadmap)
*   **端口冲突预警**：在启动前自动检测目标端口占用情况，防止因端口被占用导致的启动失败或循环重启。
